<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Teste de Stress</title>
  <link rel="stylesheet" href="assets/css/styleTeste.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/3.5.0/remixicon.css" />
</head>

<body class="teste-theme">
  <div class="teste-container">
    <form id="stressForm" class="teste-form">
      <h1 class="teste-title">Teste de Stress</h1>

      <!-- Área da pergunta -->
      <div id="question-box" class="question-box">
        <!-- Contador de perguntas -->
        <div id="counter" class="question-counter">Pergunta 1 de 12</div>
        <p id="question-text"></p>

        <!-- Opções de resposta (radio buttons) -->
        <div class="options">
          <label><input type="radio" name="answer" value="1" required> 1 - Nunca</label>
          <label><input type="radio" name="answer" value="2"> 2 - Raramente</label>
          <label><input type="radio" name="answer" value="3"> 3 - Às vezes</label>
          <label><input type="radio" name="answer" value="4"> 4 - Frequentemente</label>
          <label><input type="radio" name="answer" value="5"> 5 - Sempre</label>
        </div>
      </div>

      <!-- Botões de navegação -->
      <div class="buttons">
        <button type="button" id="nextBtn" class="next-button">Avançar</button>
        <button type="submit" id="submitBtn" class="submit-button" style="display:none;">Ver Resultado</button>
      </div>
    </form>

    <!-- Área onde é exibida a mensagem caso o teste já tenha sido feito ou o resultado -->
    <div id="result" class="teste-result" style="display:none;"></div>
  </div>

  <script>
    // =========================
    // Configurações / dados
    // =========================
    // Lista de perguntas do teste
    const questions = [
      "Costumo me sentir sobrecarregado com minhas tarefas.",
      "Tenho dificuldades para relaxar mesmo após o trabalho.",
      "Meu sono é frequentemente agitado ou insuficiente.",
      "Fico irritado facilmente por pequenas coisas.",
      "Sinto dores de cabeça ou musculares com frequência.",
      "Tenho dificuldade de concentração.",
      "Sinto que o tempo nunca é suficiente para o que preciso fazer.",
      "Tenho sentido falta de energia ou disposição.",
      "Costumo pensar constantemente nos meus problemas.",
      "Tenho pouca paciência com pessoas ao meu redor.",
      "Meu corpo dá sinais de cansaço físico frequentemente.",
      "Tenho dificuldade em “desligar” da rotina mesmo nos fins de semana."
    ];

    // Estado do fluxo do teste
    let currentQuestion = 0;
    const totalQuestions = questions.length;
    const answers = []; // armazena os valores selecionados (1..5)

    // Elementos do DOM que usaremos
    const questionText = document.getElementById("question-text");
    const nextBtn = document.getElementById("nextBtn");
    const submitBtn = document.getElementById("submitBtn");
    const form = document.getElementById("stressForm");
    const resultDiv = document.getElementById("result");
    const questionBox = document.getElementById("question-box");
    const counterDiv = document.getElementById("counter");

    // =========================
    // Funções utilitárias
    // =========================

    // Atualiza o contador visual "Pergunta X de Y"
    function updateCounter() {
      counterDiv.textContent = `Pergunta ${Math.min(currentQuestion + 1, totalQuestions)} de ${totalQuestions}`;
    }

    // Exibe a pergunta de índice `index`
    function showQuestion(index) {
      questionText.textContent = questions[index];
      updateCounter();
    }

    // Retorna o valor selecionado atualmente (ou null se nada selecionado)
    function getSelectedValue() {
      const selected = document.querySelector('input[name="answer"]:checked');
      return selected ? parseInt(selected.value, 10) : null;
    }

    // =========================
    // Verifica se já existe resultado do teste (no carregamento)
    // =========================
    window.addEventListener("DOMContentLoaded", async () => {
      try {
        // Chama o endpoint /get-test?test_type=stress
        // O backend deve retornar { exists: true } se o usuário já fez nos últimos 30 dias
        const response = await fetch("/get-test?test_type=stress");
        const data = await response.json();

        if (data.exists) {
          // Se já fez o teste nos últimos 30 dias, mostramos mensagem fixa
          form.style.display = "none";
          resultDiv.innerHTML = `
            <h2>O teste já foi realizado!</h2>
            <p>Aguarde 30 dias para refazê-lo.</p>
            <button onclick="location.href='painel.html'" class="back-button">Voltar ao Painel</button>
          `;
          resultDiv.style.display = "block";
        } else {
          // Caso não exista resultado recente, iniciamos o teste mostrando a primeira pergunta
          showQuestion(currentQuestion);
        }
      } catch (err) {
        // Em caso de erro de rede ou servidor, logamos e avisamos o usuário
        console.error("Erro ao verificar teste:", err);
        alert("Erro ao verificar se o teste já foi feito.");
      }
    });

    // =========================
    // Navegação: Avançar pergunta
    // =========================
    nextBtn.addEventListener("click", () => {
      const selectedValue = getSelectedValue();
      if (selectedValue === null) {
        alert("Selecione uma opção antes de avançar!");
        return;
      }

      // Salva a resposta atual
      answers.push(selectedValue);

      // Limpa seleção atual para a próxima pergunta
      const selectedInput = document.querySelector('input[name="answer"]:checked');
      if (selectedInput) selectedInput.checked = false;

      // Avança o índice da pergunta
      currentQuestion++;

      if (currentQuestion < totalQuestions) {
        // Mostra a próxima pergunta
        showQuestion(currentQuestion);
      } else {
        // Se respondeu todas, escondemos as perguntas e mostramos o botão de enviar
        questionBox.style.display = "none";
        nextBtn.style.display = "none";
        submitBtn.style.display = "block";
      }
    });

    // =========================
    // Envio: Finalizar e salvar o teste
    // =========================
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      // Se o usuário clicou direto em "Ver Resultado" sem clicar em Avançar,
      // tentamos pegar a resposta da última pergunta exibida.
      if (answers.length < totalQuestions) {
        const lastSelected = getSelectedValue();
        if (lastSelected !== null) answers.push(lastSelected);
      }

      // Se ainda houver perguntas sem resposta, mostramos alerta e voltamos para completar
      if (answers.length < totalQuestions) {
        alert("Por favor responda todas as perguntas antes de ver o resultado.");
        questionBox.style.display = "block";
        nextBtn.style.display = "block";
        submitBtn.style.display = "none";
        currentQuestion = answers.length;
        showQuestion(currentQuestion);
        return;
      }

      // Calcula soma e média das respostas
      const soma = answers.reduce((a, b) => a + b, 0);
      const media = soma / totalQuestions;

      // Define a mensagem com base na média
      let msg = "";
      if (media <= 2) msg = "Seu nível de stress está baixo. Você demonstra equilíbrio e boa gestão emocional.";
      else if (media <= 3.5) msg = "Nível moderado de stress. Tente desacelerar e cuidar da sua rotina.";
      else msg = "Alto nível de stress. Considere técnicas de relaxamento e, se necessário, apoio profissional.";

      try {
        // Envia resultado para o servidor
        const response = await fetch("/save-test", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            test_type: "stress",
            score: soma,
            result_text: msg
          })
        });

        // tenta ler JSON de resposta (se houver)
        let data = {};
        try { data = await response.json(); } catch (e) { /* ignora se sem json */ }

        if (!response.ok) {
          // Se o servidor retornou erro (por exemplo: já feito nos últimos 30 dias), mostramos a mensagem e retornamos ao painel
          alert(data.message || "Você já fez este teste nos últimos 30 dias.");
          window.location.href = "painel.html";
          return;
        }

        // Sucesso: redireciona para o painel do usuário e adiciona query string opcional
        window.location.href = "painel.html?test_saved=1";

      } catch (error) {
        // Em caso de erro de rede, notifica o usuário
        console.error("Erro ao salvar resultado:", error);
        alert("Erro ao enviar o resultado para o servidor.");
      }
    });
  </script>
</body>

</html>
