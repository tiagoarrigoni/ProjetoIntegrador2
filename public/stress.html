<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teste de Stress</title>
  <link rel="stylesheet" href="assets/css/styleTeste.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/3.5.0/remixicon.css">
</head>

<body class="teste-theme">
  <div class="teste-container">
    <form id="stressForm" class="teste-form">
      <h1 class="teste-title">Teste de Stress</h1>

      <!-- Área da pergunta -->
      <div id="question-box" class="question-box">
        <!-- Contador de perguntas -->
        <div id="counter" class="question-counter">Pergunta 1 de 12</div>
        <p id="question-text"></p>

        <!-- Opções de resposta (radio buttons) -->
        <div class="options">
          <label><input type="radio" name="answer" value="1"> 1 - Nunca</label>
          <label><input type="radio" name="answer" value="2"> 2 - Raramente</label>
          <label><input type="radio" name="answer" value="3"> 3 - Às vezes</label>
          <label><input type="radio" name="answer" value="4"> 4 - Frequentemente</label>
          <label><input type="radio" name="answer" value="5"> 5 - Sempre</label>
        </div>
      </div>

      <!-- Botões de navegação -->
      <div class="buttons">
        <button type="button" id="nextBtn" class="next-button">Avançar</button>
        <button type="submit" id="submitBtn" class="submit-button" style="display:none;">Ver Resultado</button>
      </div>
    </form>

    <!-- Área onde é exibida a mensagem caso o teste já tenha sido feito ou o resultado -->
    <div id="result" class="teste-result" style="display:none;"></div>
  </div>

  <script>
    // =========================
    // Configurações / dados
    // =========================
    const questions = [
      "Costumo me sentir sobrecarregado com minhas tarefas.",
      "Tenho dificuldades para relaxar mesmo após o trabalho.",
      "Meu sono é frequentemente agitado ou insuficiente.",
      "Fico irritado facilmente por pequenas coisas.",
      "Sinto dores de cabeça ou musculares com frequência.",
      "Tenho dificuldade de concentração.",
      "Sinto que o tempo nunca é suficiente para o que preciso fazer.",
      "Tenho sentido falta de energia ou disposição.",
      "Costumo pensar constantemente nos meus problemas.",
      "Tenho pouca paciência com pessoas ao meu redor.",
      "Meu corpo dá sinais de cansaço físico frequentemente.",
      "Tenho dificuldade em “desligar” da rotina mesmo nos fins de semana."
    ];

    let currentQuestion = 0;
    const totalQuestions = questions.length;
    const answers = [];

    // DOM
    const questionText = document.getElementById("question-text");
    const nextBtn = document.getElementById("nextBtn");
    const submitBtn = document.getElementById("submitBtn");
    const form = document.getElementById("stressForm");
    const resultDiv = document.getElementById("result");
    const questionBox = document.getElementById("question-box");
    const counterDiv = document.getElementById("counter");

    // util
    function updateCounter() {
      counterDiv.textContent = `Pergunta ${Math.min(currentQuestion + 1, totalQuestions)} de ${totalQuestions}`;
    }

    function showQuestion(index) {
      questionText.textContent = questions[index];
      updateCounter();
    }

    function getSelectedValue() {
      const selected = document.querySelector('input[name="answer"]:checked');
      return selected ? parseInt(selected.value, 10) : null;
    }

    function clearSelected() {
      const checked = document.querySelector('input[name="answer"]:checked');
      if (checked) checked.checked = false;
    }

    // =========================
    // Inicialização: checa /get-test (usa cookies de sessão)
    // =========================
    window.addEventListener("DOMContentLoaded", async () => {
      try {
        const resp = await fetch("/get-test?test_type=stress", {
          method: "GET",
          credentials: "include" // envia cookie de sessão
        });

        console.log("[debug] GET /get-test status:", resp.status);
        const data = await resp.json().catch(() => ({}));
        console.log("[debug] GET /get-test body:", data);

        if (resp.status === 401) {
          // sessão inválida ou não enviada: manda para login
          return window.location.href = "/index.html";
        }

        if (data.exists) {
          // servidor já retornou result_text e created_at (se existir)
          form.style.display = "none";
          resultDiv.innerHTML = `
            <h2>Resultado do Teste de Stress</h2>
            <p>${data.result_text || "Você já realizou este teste recentemente. Aguarde 30 dias para refazê-lo."}</p>
            <p style="font-size:0.9em;opacity:0.8;">Último teste: ${data.created_at || "—"}</p>
            <button onclick="location.href='painel.html'" class="back-button">Voltar ao Painel</button>
          `;
          resultDiv.style.display = "block";
          return;
        }

        // não existe → iniciar teste
        showQuestion(currentQuestion);
      } catch (err) {
        console.error("Erro ao verificar teste:", err);
        alert("Erro ao verificar se o teste já foi feito.");
      }
    });

    // =========================
    // Avançar
    // =========================
    nextBtn.addEventListener("click", () => {
      const selectedValue = getSelectedValue();
      if (selectedValue === null) {
        alert("Selecione uma opção antes de avançar!");
        return;
      }

      answers.push(selectedValue);
      clearSelected();

      currentQuestion++;

      if (currentQuestion < totalQuestions) {
        showQuestion(currentQuestion);
      } else {
        // terminou
        questionBox.style.display = "none";
        nextBtn.style.display = "none";
        submitBtn.style.display = "block";
      }
    });

    // =========================
    // Envio final
    // =========================
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      // captura a possível última resposta (caso clicou direto em enviar)
      if (answers.length < totalQuestions) {
        const last = getSelectedValue();
        if (last !== null) answers.push(last);
      }

      // valida que todas as perguntas foram respondidas
      if (answers.length < totalQuestions) {
        alert("Por favor responda todas as perguntas antes de ver o resultado.");
        questionBox.style.display = "block";
        nextBtn.style.display = "block";
        submitBtn.style.display = "none";
        currentQuestion = answers.length;
        showQuestion(currentQuestion);
        return;
      }

      const soma = answers.reduce((a, b) => a + b, 0);
      const media = soma / totalQuestions;

      let msg = "";
      if (media <= 2) msg = "Seu nível de stress está baixo. Você demonstra equilíbrio e boa gestão emocional.";
      else if (media <= 3.5) msg = "Nível moderado de stress. Tente desacelerar e cuidar da sua rotina.";
      else msg = "Alto nível de stress. Considere técnicas de relaxamento e, se necessário, apoio profissional.";

      try {
        const resp = await fetch("/save-test", {
          method: "POST",
          credentials: "include", // importante: envia cookie de sessão
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            test_type: "stress",
            score: soma,
            result_text: msg
          })
        });

        console.log("[debug] POST /save-test status:", resp.status);
        const body = await resp.json().catch(() => ({}));
        console.log("[debug] POST /save-test body:", body);

        if (resp.status === 401) {
          alert("Sessão expirada. Faça login novamente.");
          return window.location.href = "/index.html";
        }

        if (resp.status === 409) {
          alert(body.message || "Você já fez este teste nos últimos 30 dias.");
          return window.location.href = "painel.html";
        }

        if (!resp.ok) {
          alert(body.message || "Erro ao salvar o teste.");
          return window.location.href = "painel.html";
        }

        // sucesso: mostra resultado e redireciona depois de 1s
        form.style.display = "none";
        resultDiv.innerHTML = `
          <h2>Resultado do Teste de Stress</h2>
          <p>${msg}</p>
          <p style="font-size:0.9em;opacity:0.8;">Você será redirecionado ao painel em instantes...</p>
        `;
        resultDiv.style.display = "block";

        setTimeout(() => {
          window.location.href = "painel.html?test_saved=1";
        }, 1000);

      } catch (err) {
        console.error("Erro ao enviar resultado:", err);
        alert("Erro ao enviar o resultado para o servidor.");
      }
    });
  </script>

</body>

</html>
