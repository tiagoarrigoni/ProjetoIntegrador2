<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Perfil Completo</title>
  <link rel="stylesheet" href="assets/css/informacoes.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/3.5.0/remixicon.css">
</head>

<body>
  <main class="info-container">
    <h1>Perfil Completo</h1>

    <section id="perfil-info" class="dados-fixos">
      <p>Carregando informa√ß√µes pessoais...</p>
    </section>

    <section id="perfil-resumo" class="dados-fixos">
      <p>Carregando resultados dos testes...</p>
    </section>

    <section id="diagnostico" class="dados-fixos">
      <p>Gerando diagn√≥stico...</p>
    </section>

    <button onclick="window.location.href='painel.html'" class="back-btn">Voltar ao Painel</button>
  </main>

<script>
window.addEventListener("DOMContentLoaded", async () => {
  const perfilDiv = document.getElementById("perfil-info");
  const resumoDiv = document.getElementById("perfil-resumo");
  const diagDiv = document.getElementById("diagnostico");

  try {
    const [userInfoRes, testsRes] = await Promise.all([
      fetch("/user-info"),
      fetch("/my-tests")
    ]);

    const userInfo = await userInfoRes.json();
    const tests = await testsRes.json();

    // ======= INFORMA√á√ïES PESSOAIS =======
    if (userInfo && (userInfo.nome_completo || userInfo.nascimento)) {
      const idade = userInfo.nascimento
        ? Math.floor((Date.now() - new Date(userInfo.nascimento)) / (1000 * 60 * 60 * 24 * 365))
        : "N/A";

      perfilDiv.innerHTML = `
        <h2>Informa√ß√µes Pessoais</h2>
        ${userInfo.nome_completo ? `<p><strong>Nome Completo:</strong> ${userInfo.nome_completo}</p>` : ""}
        ${userInfo.nascimento ? `<p><strong>Data de Nascimento:</strong> ${userInfo.nascimento}</p>` : ""}
        <p><strong>Idade:</strong> ${idade} anos</p>
        ${userInfo.peso ? `<p><strong>Peso:</strong> ${userInfo.peso} kg</p>` : ""}
        ${userInfo.altura ? `<p><strong>Altura:</strong> ${userInfo.altura} cm</p>` : ""}
      `;
    } else {
      perfilDiv.innerHTML = "<p>Informa√ß√µes pessoais n√£o encontradas.</p>";
    }

    // ======= RESULTADOS DOS TESTES =======
    if (tests && tests.length > 0) {
      resumoDiv.innerHTML = `
        <h2>Resultados dos Testes</h2>
        ${tests.map(t => `
          <p><strong>${t.test_type.toUpperCase()}:</strong> ${t.result_text}</p>
        `).join("")}
      `;
    } else {
      resumoDiv.innerHTML = "<p>Nenhum teste encontrado.</p>";
    }

    // ======= DIAGN√ìSTICO FINAL =======
    if (tests.length > 0 && userInfo && userInfo.peso) {
      let soma = 0;
      tests.forEach(t => soma += t.score);
      const media = soma / tests.length;

      const idade = userInfo.nascimento
        ? Math.floor((Date.now() - new Date(userInfo.nascimento)) / (1000 * 60 * 60 * 24 * 365))
        : 0;
      const peso = parseFloat(userInfo.peso);

      let diagnostico = "";

      if (media < 25)
        diagnostico = "Voc√™ apresenta excelente equil√≠brio emocional e bem-estar geral.";
      else if (media < 45)
        diagnostico = "Seu perfil indica um n√≠vel moderado de estresse. Cuide de pausas e lazer.";
      else
        diagnostico = "N√≠veis elevados de estresse foram identificados. Busque relaxamento e apoio emocional.";

      // Condi√ß√µes f√≠sicas
      if (peso > 90)
        diagnostico += " ‚ö†Ô∏è O peso est√° acima do ideal ‚Äî recomenda-se atividade f√≠sica e acompanhamento nutricional.";
      else if (idade > 45)
        diagnostico += " üëü Caminhadas leves e boa alimenta√ß√£o podem melhorar sua qualidade de vida.";
      else
        diagnostico += " üí™ Voc√™ est√° com bom equil√≠brio f√≠sico e emocional.";

      diagDiv.innerHTML = `
        <h2>Diagn√≥stico Final</h2>
        <p>${diagnostico}</p>
      `;
    } else {
      diagDiv.innerHTML = "<p>Complete seus testes e preencha suas informa√ß√µes pessoais para ver o diagn√≥stico.</p>";
    }

  } catch (err) {
    console.error("Erro ao carregar perfil:", err);
    diagDiv.innerHTML = `<p style="color:red;">Erro ao carregar informa√ß√µes: ${err.message}</p>`;
  }
});
</script>

</body>
</html>
