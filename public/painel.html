<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel do Usuário</title>
  <link rel="stylesheet" href="assets/css/painel.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/3.5.0/remixicon.css" />
</head>

<body>
  <!-- Cabeçalho -->
  <header class="painel-header">
    <div class="avatar-wrapper">
      <img id="user-photo" src="assets/img/avatar1.png" alt="Foto do usuário" onclick="toggleAvatarOptions()" />

      <!-- opções de avatar -->
      <div class="photo-options" id="photo-options" style="display:none;">
        <img src="assets/img/avatar/avatar1.avif" onclick="changeAvatar('avatar1.avif')" />
        <img src="assets/img/avatar/avatar2.avif" onclick="changeAvatar('avatar2.avif')" />
        <img src="assets/img/avatar/avatar3.avif" onclick="changeAvatar('avatar3.avif')" />
      </div>
    </div>

    <h1>
      Bem-vindo(a), <strong id="username">USUÁRIO</strong>
    </h1>

    <button class="logout-btn" id="logoutBtn">Sair</button>
  </header>

  <!-- Conteúdo principal -->
  <main class="painel-main">
    <div class="action-buttons">
      <button id="perfil-btn" class="perfil-btn" onclick="goToPerfil()">Perfil Completo</button>
      <button id="info-btn" class="info-btn" onclick="goToInformacoes()">Informações Pessoais</button>
    </div>

    <!-- Seção dos testes -->
    <section class="test-section">
      <div class="test-card" id="stress-card" onclick="goToTest('stress.html')">
        <img src="assets/img/stress.jpg" alt="Teste de Stress" />
        <h3>Teste de Stress</h3>
      </div>

      <div class="test-card" id="perfil-card" onclick="goToTest('perfil.html')">
        <img src="assets/img/perfil.jpg" alt="Teste de Perfil" />
        <h3>Teste de Perfil</h3>
      </div>

      <div class="test-card" id="humor-card" onclick="goToTest('humor.html')">
        <img src="assets/img/humor.jpg" alt="Teste de Humor" />
        <h3>Teste de Humor</h3>
      </div>
    </section>
  </main>

  <!-- Rodapé -->
  <footer class="painel-footer">
    <p>Todos os direitos desse site são reservados a <strong>Tiago Arrigoni</strong></p>
  </footer>

  <!-- Notificação de sucesso -->
  <div id="notification"
    style="display:none; position:fixed; top:16px; right:16px; z-index:9999; padding:12px 16px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.12); background:#e6ffed; color:#054a22; font-weight:600;">
    Teste salvo com sucesso!
  </div>

  <script>
    // UI helpers
    function toggleAvatarOptions() {
      const options = document.getElementById("photo-options");
      options.style.display = options.style.display === "flex" ? "none" : "flex";
    }

    function changeAvatar(imgName) {
      const mainPhoto = document.getElementById("user-photo");
      mainPhoto.src = "assets/img/avatar/" + imgName;
      document.getElementById("photo-options").style.display = "none";
    }

    // Navegação
    function goToPerfil() {
      window.location.href = "resultadoPerfil.html";
    }
    function goToInformacoes() {
      window.location.href = "informacoes.html";
    }
    function goToTest(page) {
      window.location.href = page;
    }

    // logout: tenta POST /auth/logout, se falhar redireciona para index
    async function logout() {
      try {
        // tenta rota POST de logout (se existir)
        await fetch("/auth/logout", { method: "POST", credentials: "include" });
      } catch (err) {
        // ignore — apenas redirecionar
      } finally {
        window.location.href = "index.html";
      }
    }

    document.getElementById("logoutBtn").addEventListener("click", logout);

    // Carrega dados do usuário e status dos testes
    window.addEventListener("DOMContentLoaded", async () => {
      try {
        // busca o usuário logado (rota original: /session-user)
        const userRes = await fetch("/session-user", { credentials: "include" });

        if (!userRes.ok) {
          // se 401 -> manda pro login
          if (userRes.status === 401) {
            window.location.href = "index.html";
            return;
          }
          console.warn("Falha ao obter usuário:", userRes.status);
        } else {
          const user = await userRes.json();
          const name = (user.username || "Usuário").toString().toUpperCase();
          document.getElementById("username").textContent = name;
        }

        // busca histórico de testes (rota original: /my-tests)
        const testsRes = await fetch("/my-tests", { credentials: "include" });

        if (!testsRes.ok) {
          if (testsRes.status === 401) {
            window.location.href = "index.html";
            return;
          }
          console.warn("Falha ao obter testes:", testsRes.status);
        } else {
          const tests = await testsRes.json();
          let completedCount = 0;

          tests.forEach((t) => {
            const card = document.getElementById(`${t.test_type}-card`);
            if (card) {
              card.classList.add("completed");
              completedCount++;
            }
          });

          // se todos os testes concluídos, marca botão perfil
          if (completedCount >= 3) {
            const perfilBtn = document.getElementById("perfil-btn");
            if (perfilBtn) perfilBtn.classList.add("completed");
          }
        }
      } catch (err) {
        console.error("Erro ao carregar dados do painel:", err);
      }

      // Notificação: se url contiver test_saved=1
      const params = new URLSearchParams(window.location.search);
      if (params.get("test_saved") === "1" || params.get("test_saved") === "true") {
        const n = document.getElementById("notification");
        n.style.display = "block";
        setTimeout(() => {
          n.style.transition = "opacity 0.6s";
          n.style.opacity = "0";
          setTimeout(() => n.remove(), 600);
        }, 3500);

        // limpa parâmetro da url
        const cleanUrl = window.location.origin + window.location.pathname;
        window.history.replaceState({}, document.title, cleanUrl);
      }
    });
  </script>
</body>

</html>